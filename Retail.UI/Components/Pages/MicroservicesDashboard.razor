@page "/dashboard"
@using System.Text.Json
@using System.Net.Http
@using System.Timers
@using Retail.UI.Models
@inject HttpClient Http
@inject ILogger<MicroservicesDashboard> Logger



<PageTitle>Retail Microservices Dashboard</PageTitle>
<link href="css/dashboard.css" rel="stylesheet" />

<div class="dashboard-container">






    <!-- Business Data Section -->
    <div class="dashboard-section">
        <h2>üì¶ Business Data</h2>
        <div class="data-tabs">
            <div class="tab-buttons">
                <button class="tab-btn @(activeTab == "products" ? "active" : "")" @onclick="SwitchToProducts">
                    üì¶ Products & Inventory
                </button>
                <button class="tab-btn @(activeTab == "orders" ? "active" : "")" @onclick="SwitchToOrders">
                    üìã Orders
                </button>
                <button class="tab-btn @(activeTab == "customers" ? "active" : "")" @onclick="SwitchToCustomers">
                    üë• Customers
                </button>
                <button class="tab-btn @(activeTab == "notifications" ? "active" : "")" @onclick="SwitchToNotifications">
                    üîî Notifications
                </button>
            </div>

            <div class="tab-content">
                @if (activeTab == "products")
                {
                    <div class="products-tab">
                        <div class="tab-header">
                            <h3>Products & Inventory</h3>
                            <div class="tab-actions">
                                <button class="btn btn-primary" @onclick="RefreshProducts">üîÑ Refresh</button>
                            </div>
                        </div>
                        @if (products != null && products.Any())
                        {
                            <div class="data-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>Unit Price</th>
                                            <th>Inventory</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var product in products)
                                        {
                                            <tr>
                                                <td>@product.Id</td>
                                                <td>@product.Name</td>
                                                <td>$@product.UnitPrice.ToString("F2")</td>
                                                <td>
                                                    <span class="inventory-count @(product.Inventory > 10 ? "high" : product.Inventory > 0 ? "medium" : "low")">
                                                        @product.Inventory
                                                    </span>
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary" @onclick="() => ShowInventoryModal(product)">
                                                        üìù Adjust
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="no-data">No products available</div>
                        }
                    </div>
                }
                else if (activeTab == "orders")
                {
                    <div class="orders-tab">
                        <div class="tab-header">
                            <h3>Orders</h3>
                            <div class="tab-actions">
                                <button class="btn btn-primary" @onclick="RefreshOrders">üîÑ Refresh</button>
                                <button class="btn btn-success" @onclick="ShowCreateOrderModal">‚ûï Create Order</button>
                            </div>
                        </div>
                        @if (orders != null && orders.Any())
                        {
                            <div class="data-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Order #</th>
                                            <th>Customer Name</th>
                                            <th>Order Date</th>
                                            <th>Total Amount</th>
                                            <th>Items Count</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var order in orders)
                                        {
                                            <tr class="order-row">
                                                <td><strong>#@order.OrderId</strong></td>
                                                <td><strong>@order.CustomerName</strong></td>
                                                <td>@order.OrderDate.ToString("MMM dd, yyyy")</td>
                                                <td><strong>$@order.TotalAmount.ToString("F2")</strong></td>
                                                <td>@(order.LineItems?.Count ?? 0) items</td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-info" @onclick="() => ToggleOrderDetails(order.OrderId)">
                                                        @(expandedOrders.Contains(order.OrderId) ? "üëÅÔ∏è Hide" : "üëÅÔ∏è Show") Details
                                                    </button>
                                                </td>
                                            </tr>
                                            @if (expandedOrders.Contains(order.OrderId) && order.LineItems != null && order.LineItems.Any())
                                            {
                                                <tr class="order-details-row">
                                                    <td colspan="6">
                                                        <div class="order-details">
                                                            <h4>üì¶ Order Items</h4>
                                                            <div class="line-items-table">
                                                                <table>
                                                                    <thead>
                                                                        <tr>
                                                                            <th>Item ID</th>
                                                                            <th>SKU ID</th>
                                                                            <th>Quantity</th>
                                                                            <th>Unit Price</th>
                                                                            <th>Line Total</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        @foreach (var item in order.LineItems)
                                                                        {
                                                                            <tr>
                                                                                <td>@item.Id</td>
                                                                                <td>@item.SkuId</td>
                                                                                <td>@item.Qty</td>
                                                                                <td>$@(GetProductPrice(item.SkuId)?.ToString("F2") ?? "N/A")</td>
                                                                                <td>$@((GetProductPrice(item.SkuId) * item.Qty)?.ToString("F2") ?? "N/A")</td>
                                                                            </tr>
                                                                        }
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                    </tbody>
                                </table>
                    </div>
                        }
                        else
                        {
                            <div class="no-data">No orders available</div>
                        }
                    </div>
                }
                else if (activeTab == "customers")
                {
                    <div class="customers-tab">
                        <div class="tab-header">
                            <h3>Customers</h3>
                            <button class="btn btn-primary" @onclick="RefreshCustomers">üîÑ Refresh</button>
                        </div>
                        @if (customers != null && customers.Any())
                        {
                            <div class="data-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>First Name</th>
                                            <th>Last Name</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var customer in customers)
                                        {
                                            <tr>
                                                <td>@customer.Id</td>
                                                <td>@customer.FirstName</td>
                                                <td>@customer.LastName</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="no-data">No customers available</div>
                        }
                    </div>
                }
                else if (activeTab == "notifications")
                {
                    <div class="notifications-tab">
                        <div class="tab-header">
                            <h3>Customer Notifications</h3>
                            <button class="btn btn-primary" @onclick="RefreshNotifications">üîÑ Refresh</button>
                        </div>
                        @if (notifications != null && notifications.Any())
                        {
                            <div class="data-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Notification ID</th>
                                            <th>Customer ID</th>
                                            <th>Order ID</th>
                                            <th>Message</th>
                                            <th>Order Date</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var notification in notifications)
                                        {
                                            <tr>
                                                <td>@notification.Id</td>
                                                <td>@notification.CustomerId</td>
                                                <td>@notification.OrderId</td>
                                                <td>@notification.Message</td>
                                                <td>@notification.OrderDate.ToString("MMM dd, yyyy")</td>
                                                <td>
                                                    <span class="status-badge success">‚úÖ Sent</span>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="no-data">No notifications available</div>
                        }
                    </div>
                }
            }
        </div>
    </div>



    <!-- Event Flow Visualization Section -->
    <div class="dashboard-section">
        <h2>üìä Order Processing Events</h2>
        <div class="event-flow">
            <div class="event-timeline">
                @if (eventHistory != null && eventHistory.Any())
                {
                    @foreach (var evt in eventHistory.OrderByDescending(e => e.Timestamp))
                    {
                        <div class="event-item @(evt.Status == "Success" ? "success" : evt.Status == "Error" ? "error" : "")">
                            <div class="event-header">
                                <span class="event-service">@evt.ServiceName</span>
                                <span class="event-time">@evt.Timestamp.ToString("HH:mm:ss")</span>
                            </div>
                            <div class="event-message">@evt.Message</div>
                        </div>
                    }
                }
                else
                {
                    <div class="no-data">
                        <p>No events yet. Create an order to see the event flow in action!</p>
                        <button class="btn btn-primary" @onclick="ShowCreateOrderModal">‚ûï Create Your First Order</button>
                    </div>
                }
            </div>
        </div>
    </div>
</div>



<!-- Inventory Adjustment Modal -->
@if (showInventoryModal)
{
    <div class="modal-overlay" @onclick="CloseInventoryModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Adjust Inventory - @selectedProduct?.Name</h3>
                <button class="modal-close" @onclick="CloseInventoryModal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Current Inventory: @selectedProduct?.Inventory</label>
                    <input type="number" class="form-control" @bind="newInventoryValue" min="0" />
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseInventoryModal">Cancel</button>
                <button class="btn btn-primary" @onclick="UpdateInventory">Update Inventory</button>
            </div>
        </div>
    </div>
}

<!-- Create Order Modal -->
@if (showCreateOrderModal)
{
    <div class="modal-overlay" @onclick="CloseCreateOrderModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Create New Order</h3>
                <button class="modal-close" @onclick="CloseCreateOrderModal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Customer:</label>
                    <select class="form-control" @bind="newOrder.CustomerId">
                        <option value="0">-- Select Customer --</option>
                        @if (customers != null)
                        {
                            @foreach (var customer in customers)
                            {
                                <option value="@customer.Id">@customer.Id - @customer.FirstName @customer.LastName</option>
                            }
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label>Product:</label>
                    <select class="form-control" @bind="newOrderLineItem.SkuId">
                        <option value="0">-- Select Product --</option>
                        @if (products != null)
                        {
                            @foreach (var product in products)
                            {
                                <option value="@product.Id">@product.Id - @product.Name ($@product.UnitPrice.ToString("F2")) - Stock: @product.Inventory</option>
                            }
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label>Quantity:</label>
                    <input type="number" class="form-control" @bind="newOrderLineItem.Qty" min="1" />
                </div>
                @if (newOrderLineItem.SkuId > 0 && newOrderLineItem.Qty > 0)
                {
                    var selectedProduct = products?.FirstOrDefault(p => p.Id == newOrderLineItem.SkuId);
                    if (selectedProduct != null)
                    {
                        var total = selectedProduct.UnitPrice * newOrderLineItem.Qty;
                        var canOrder = selectedProduct.Inventory >= newOrderLineItem.Qty;
                        <div class="order-summary">
                            <h4>Order Summary</h4>
                            <p><strong>Product:</strong> @selectedProduct.Name</p>
                            <p><strong>Unit Price:</strong> $@selectedProduct.UnitPrice.ToString("F2")</p>
                            <p><strong>Quantity:</strong> @newOrderLineItem.Qty</p>
                            <p><strong>Total:</strong> $@total.ToString("F2")</p>
                            <p><strong>Available Stock:</strong> @selectedProduct.Inventory</p>
                            @if (!canOrder)
                            {
                                <div class="alert alert-warning">
                                    ‚ö†Ô∏è Insufficient inventory! Available: @selectedProduct.Inventory, Requested: @newOrderLineItem.Qty
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-success">
                                    ‚úÖ Order can be fulfilled with current inventory
                                </div>
                            }
                        </div>
                    }
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseCreateOrderModal">Cancel</button>
                <button class="btn btn-success" @onclick="CreateOrder">Create Order</button>
            </div>
        </div>
    </div>
}

</div>